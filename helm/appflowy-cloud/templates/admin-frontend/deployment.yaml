{{- if index .Values "admin-frontend" "enabled" }}
{{- $admin := index .Values "admin-frontend" }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "appflowy.admin.fullname" . }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
    app.kubernetes.io/component: admin-frontend
spec:
  replicas: {{ $admin.replicaCount }}
  selector:
    matchLabels:
      {{- include "appflowy.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: admin-frontend
  template:
    metadata:
      {{- with $admin.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "appflowy.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: admin-frontend
    spec:
      {{- include "appflowy.imagePullSecrets" . | nindent 6 }}
      serviceAccountName: {{ include "appflowy.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      containers:
        - name: admin-frontend
          securityContext:
            {{- toYaml .Values.containerSecurityContext | nindent 12 }}
          image: {{ include "appflowy.image" (dict "Values" .Values "image" $admin.image) | quote }}
          imagePullPolicy: {{ $admin.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: RUST_LOG
              value: {{ index .Values "appflowy-cloud" "config" "rustLog" | default "info" | quote }}
            # Next.js start script binds to HOSTNAME; override so port-forward works.
            - name: HOSTNAME
              value: "0.0.0.0"
            # Next.js admin frontend uses APPFLOWY_* envs; Rust admin frontend uses ADMIN_FRONTEND_*.
            - name: APPFLOWY_GOTRUE_BASE_URL
              value: {{ include "appflowy.gotrue.externalUrl" . | quote }}
            - name: APPFLOWY_BASE_URL
              value: {{ include "appflowy.baseUrl" . | quote }}
            {{- if eq (include "appflowy.redis.authEnabled" .) "true" }}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "appflowy.redis.secretName" . }}
                  key: {{ include "appflowy.redis.secretKey" . }}
            {{- end }}
            - name: ADMIN_FRONTEND_REDIS_URL
              value: {{ include "appflowy.redis.url" . | quote }}
            - name: ADMIN_FRONTEND_GOTRUE_URL
              value: {{ include "appflowy.gotrue.internalUrl" . | quote }}
            - name: ADMIN_FRONTEND_APPFLOWY_CLOUD_URL
              value: {{ include "appflowy.cloud.internalUrl" . | quote }}
            {{- if $admin.config.pathPrefix }}
            - name: ADMIN_FRONTEND_PATH_PREFIX
              value: {{ $admin.config.pathPrefix | quote }}
            {{- end }}
            {{- if $admin.config.oauth.clientId }}
            - name: ADMIN_FRONTEND_OAUTH_CLIENT_ID
              value: {{ $admin.config.oauth.clientId | quote }}
            {{- end }}
            {{- if $admin.config.oauth.clientSecret }}
            - name: ADMIN_FRONTEND_OAUTH_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "appflowy.admin.fullname" . }}-secret
                  key: oauth-client-secret
            {{- end }}
            {{- if $admin.config.oauth.allowableRedirectUris }}
            - name: ADMIN_FRONTEND_OAUTH_ALLOWABLE_REDIRECT_URIS
              value: {{ $admin.config.oauth.allowableRedirectUris | quote }}
            {{- end }}
          livenessProbe:
            httpGet:
              path: {{ $admin.config.pathPrefix | default "/" }}
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: {{ $admin.config.pathPrefix | default "/" }}
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            {{- toYaml $admin.resources | nindent 12 }}
      {{- with $admin.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $admin.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with $admin.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}
