{{- if not .Values.global.jwt.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "appflowy.jwt.secretName" . }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
type: Opaque
data:
  {{- $jwtKey := include "appflowy.jwt.secretKey" . }}
  {{- if .Values.global.jwt.secret }}
  {{ $jwtKey }}: {{ .Values.global.jwt.secret | b64enc | quote }}
  {{- else }}
  {{- $existing := lookup "v1" "Secret" .Release.Namespace (include "appflowy.jwt.secretName" .) }}
  {{- if and $existing (hasKey $existing.data $jwtKey) }}
  {{ $jwtKey }}: {{ index $existing.data $jwtKey | quote }}
  {{- else }}
  {{ $jwtKey }}: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  {{- end }}
{{- end }}
---
{{- if and (not .Values.global.postgresql.existingSecret) (not .Values.postgresql.enabled) }}
{{- $pgSecretName := printf "%s-postgresql-secret" (include "appflowy.fullname" .) }}
{{- $existingPgSecret := lookup "v1" "Secret" .Release.Namespace $pgSecretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $pgSecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
type: Opaque
data:
  postgres-password: {{ if .Values.global.postgresql.password -}}{{ .Values.global.postgresql.password | b64enc | quote }}{{- else if and $existingPgSecret (hasKey $existingPgSecret.data "postgres-password") -}}{{ index $existingPgSecret.data "postgres-password" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
{{- end }}
---
{{- if and (eq (include "appflowy.redis.authEnabled" .) "true") (not .Values.global.redis.existingSecret) (not (and .Values.redis.enabled .Values.redis.auth.enabled)) }}
{{- $redisSecretName := include "appflowy.redis.secretName" . }}
{{- $redisSecretKey := include "appflowy.redis.secretKey" . }}
{{- $existingRedisSecret := lookup "v1" "Secret" .Release.Namespace $redisSecretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $redisSecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
type: Opaque
data:
  {{ $redisSecretKey }}: {{ if .Values.global.redis.password -}}{{ .Values.global.redis.password | b64enc | quote }}{{- else if and $existingRedisSecret (hasKey $existingRedisSecret.data $redisSecretKey) -}}{{ index $existingRedisSecret.data $redisSecretKey | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
{{- end }}
---
{{- if and (not .Values.global.s3.existingSecret) (not .Values.minio.enabled) }}
{{- $s3SecretName := printf "%s-s3-secret" (include "appflowy.fullname" .) }}
{{- $existingS3Secret := lookup "v1" "Secret" .Release.Namespace $s3SecretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $s3SecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
type: Opaque
data:
  {{- $accessKeyName := .Values.global.s3.secretKeys.accessKey | default "root-user" }}
  {{- $secretKeyName := .Values.global.s3.secretKeys.secretKey | default "root-password" }}
  {{ $accessKeyName }}: {{ if .Values.global.s3.accessKey -}}{{ .Values.global.s3.accessKey | b64enc | quote }}{{- else if and $existingS3Secret (hasKey $existingS3Secret.data $accessKeyName) -}}{{ index $existingS3Secret.data $accessKeyName | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{ $secretKeyName }}: {{ if .Values.global.s3.secretKey -}}{{ .Values.global.s3.secretKey | b64enc | quote }}{{- else if and $existingS3Secret (hasKey $existingS3Secret.data $secretKeyName) -}}{{ index $existingS3Secret.data $secretKeyName | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
{{- end }}
---
{{- if .Values.gotrue.enabled }}
{{- $gotrueSecretName := printf "%s-secret" (include "appflowy.gotrue.fullname" .) }}
{{- $existingGoTrueSecret := lookup "v1" "Secret" .Release.Namespace $gotrueSecretName }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $gotrueSecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
    app.kubernetes.io/component: gotrue
type: Opaque
data:
  {{- if .Values.gotrue.config.adminPassword }}
  admin-password: {{ .Values.gotrue.config.adminPassword | b64enc | quote }}
  {{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "admin-password") }}
  admin-password: {{ index $existingGoTrueSecret.data "admin-password" | quote }}
  {{- else }}
  admin-password: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  {{- if .Values.gotrue.config.smtp.enabled }}
  smtp-password: {{ if .Values.gotrue.config.smtp.password -}}{{ .Values.gotrue.config.smtp.password | b64enc | quote }}{{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "smtp-password") -}}{{ index $existingGoTrueSecret.data "smtp-password" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{- end }}
  {{- if .Values.gotrue.config.oauth.google.enabled }}
  google-oauth-secret: {{ if .Values.gotrue.config.oauth.google.secret -}}{{ .Values.gotrue.config.oauth.google.secret | b64enc | quote }}{{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "google-oauth-secret") -}}{{ index $existingGoTrueSecret.data "google-oauth-secret" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{- end }}
  {{- if .Values.gotrue.config.oauth.github.enabled }}
  github-oauth-secret: {{ if .Values.gotrue.config.oauth.github.secret -}}{{ .Values.gotrue.config.oauth.github.secret | b64enc | quote }}{{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "github-oauth-secret") -}}{{ index $existingGoTrueSecret.data "github-oauth-secret" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{- end }}
  {{- if .Values.gotrue.config.oauth.discord.enabled }}
  discord-oauth-secret: {{ if .Values.gotrue.config.oauth.discord.secret -}}{{ .Values.gotrue.config.oauth.discord.secret | b64enc | quote }}{{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "discord-oauth-secret") -}}{{ index $existingGoTrueSecret.data "discord-oauth-secret" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{- end }}
  {{- if .Values.gotrue.config.oauth.apple.secret }}
  apple-oauth-secret: {{ .Values.gotrue.config.oauth.apple.secret | b64enc | quote }}
  {{- end }}
  {{- if .Values.gotrue.config.saml.enabled }}
  saml-private-key: {{ if .Values.gotrue.config.saml.privateKey -}}{{ .Values.gotrue.config.saml.privateKey | b64enc | quote }}{{- else if and $existingGoTrueSecret (hasKey $existingGoTrueSecret.data "saml-private-key") -}}{{ index $existingGoTrueSecret.data "saml-private-key" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
  {{- end }}
{{- end }}
---
{{- if index .Values "appflowy-cloud" "enabled" }}
{{- $cloudSecretName := printf "%s-secret" (include "appflowy.cloud.fullname" .) }}
{{- $existingCloudSecret := lookup "v1" "Secret" .Release.Namespace $cloudSecretName }}
{{- $existingCloudData := and $existingCloudSecret (hasKey $existingCloudSecret "data") }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $cloudSecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
    app.kubernetes.io/component: appflowy-cloud
type: Opaque
{{- $mailer := index .Values "appflowy-cloud" "config" "mailer" }}
{{- if or $mailer.enabled (and $existingCloudData (hasKey $existingCloudSecret.data "smtp-password")) }}
data:
  smtp-password: {{ if $mailer.password -}}{{ $mailer.password | b64enc | quote }}{{- else if and $existingCloudData (hasKey $existingCloudSecret.data "smtp-password") -}}{{ index $existingCloudSecret.data "smtp-password" | quote }}{{- else -}}{{ "" | b64enc | quote }}{{- end }}
{{- else }}
data: {}
{{- end }}
{{- end }}
---
{{- if index .Values "appflowy-ai" "enabled" }}
{{- $aiSecretName := printf "%s-secret" (include "appflowy.ai.fullname" .) }}
{{- $existingAiSecret := lookup "v1" "Secret" .Release.Namespace $aiSecretName }}
{{- $existingAiData := and $existingAiSecret (hasKey $existingAiSecret "data") }}
{{- $aiSecrets := index .Values "appflowy-ai" "secrets" }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $aiSecretName }}
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
    app.kubernetes.io/component: appflowy-ai
type: Opaque
{{- if or
  $aiSecrets.openaiApiKey
  $aiSecrets.anthropicApiKey
  $aiSecrets.deepseekApiKey
  $aiSecrets.azureOpenaiApiKey
  (and $existingAiData (hasKey $existingAiSecret.data "openai-api-key"))
  (and $existingAiData (hasKey $existingAiSecret.data "anthropic-api-key"))
  (and $existingAiData (hasKey $existingAiSecret.data "deepseek-api-key"))
  (and $existingAiData (hasKey $existingAiSecret.data "azure-openai-api-key"))
}}
data:
  {{- if or $aiSecrets.openaiApiKey (and $existingAiData (hasKey $existingAiSecret.data "openai-api-key")) }}
  openai-api-key: {{ if $aiSecrets.openaiApiKey -}}{{ $aiSecrets.openaiApiKey | b64enc | quote }}{{- else -}}{{ index $existingAiSecret.data "openai-api-key" | quote }}{{- end }}
  {{- end }}
  {{- if or $aiSecrets.anthropicApiKey (and $existingAiData (hasKey $existingAiSecret.data "anthropic-api-key")) }}
  anthropic-api-key: {{ if $aiSecrets.anthropicApiKey -}}{{ $aiSecrets.anthropicApiKey | b64enc | quote }}{{- else -}}{{ index $existingAiSecret.data "anthropic-api-key" | quote }}{{- end }}
  {{- end }}
  {{- if or $aiSecrets.deepseekApiKey (and $existingAiData (hasKey $existingAiSecret.data "deepseek-api-key")) }}
  deepseek-api-key: {{ if $aiSecrets.deepseekApiKey -}}{{ $aiSecrets.deepseekApiKey | b64enc | quote }}{{- else -}}{{ index $existingAiSecret.data "deepseek-api-key" | quote }}{{- end }}
  {{- end }}
  {{- if or $aiSecrets.azureOpenaiApiKey (and $existingAiData (hasKey $existingAiSecret.data "azure-openai-api-key")) }}
  azure-openai-api-key: {{ if $aiSecrets.azureOpenaiApiKey -}}{{ $aiSecrets.azureOpenaiApiKey | b64enc | quote }}{{- else -}}{{ index $existingAiSecret.data "azure-openai-api-key" | quote }}{{- end }}
  {{- end }}
{{- else }}
data: {}
{{- end }}
{{- end }}
---
{{- if index .Values "admin-frontend" "enabled" }}
{{- if index .Values "admin-frontend" "config" "oauth" "clientSecret" }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "appflowy.admin.fullname" . }}-secret
  labels:
    {{- include "appflowy.labels" . | nindent 4 }}
    app.kubernetes.io/component: admin-frontend
type: Opaque
data:
  oauth-client-secret: {{ index .Values "admin-frontend" "config" "oauth" "clientSecret" | b64enc | quote }}
{{- end }}
{{- end }}
